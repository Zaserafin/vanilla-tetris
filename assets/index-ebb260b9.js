(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const n of i)if(n.type==="childList")for(const l of n.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&s(l)}).observe(document,{childList:!0,subtree:!0});function t(i){const n={};return i.integrity&&(n.integrity=i.integrity),i.referrerPolicy&&(n.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?n.credentials="include":i.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(i){if(i.ep)return;i.ep=!0;const n=t(i);fetch(i.href,n)}})();class x{constructor(e=60,t=60){this.isRunning=!1,this.gameTickRate=e,this.lastGameTick=0,this.lastRender=0,this.targetFPS=t,this.frameDuration=1e3/this.targetFPS,this.gameLoop=this.gameLoop.bind(this),this.renderLoop=this.renderLoop.bind(this)}start(){this.isRunning||(this.isRunning=!0,this.gameLoop(),this.renderLoop())}stop(){this.isRunning=!1}update(){}render(){}gameLoop(){if(this.isRunning){const e=performance.now();e-this.lastGameTick>=1e3/this.gameTickRate&&(this.update(),this.lastGameTick=e),requestAnimationFrame(this.gameLoop)}}renderLoop(){if(this.isRunning){const e=performance.now();e-this.lastRender>=this.frameDuration&&(this.render(),this.lastRender=e),requestAnimationFrame(this.renderLoop)}}}const a={playerScore:0,tetrisCount:0,highScore:0,gameOver:!1};class C{constructor(e,t,s,i="white"){if(!e)throw new Error("Cannot initialize renderer without a proper canvas");this.canvas=e,this.context=this.canvas.getContext("2d"),this.resize({width:t,height:s}),this.setBackgroundColor(i)}setBackgroundColor(e){this.canvas.style.backgroundColor=e}clear(){this.context.clearRect(0,0,this.canvas.width,this.canvas.height)}drawRect(e,t,s,i,n){this.context.fillStyle=n,this.context.fillRect(e,t,s,i)}drawText(e,t,s,i,n){this.context.fillStyle=n,this.context.font=i,this.context.fillText(e,t,s)}drawImage(e,t,s,i,n){this.context.drawImage(e,t,s,i,n)}getCanvasInfo(){return{width:this.canvas.width,height:this.canvas.height,backgroundColor:this.canvas.style.backgroundColor}}resize({width:e=null,height:t=null}){e&&(this.canvas.width=e),t&&(this.canvas.height=t)}}function m(o){return Object.create(o[Math.floor(Math.random()*o.length)])}function w(o,e){let t=[];for(let s=0;s<e;s++){const i=[];for(let n=0;n<o;n++)i.push(0);t.push(i)}return t}function u(o,e,t,s,i="down"){let n={x:Math.trunc(e.x),y:Math.trunc(e.y)};for(let l=0;l<e.template.length;l++)for(let g=0;g<e.template[l].length;g++){if(e.template[l][g]===0)continue;let d=g+n.x,f=l+n.y;if(i==="down"&&(f+1>=s||o[f+1][d]!==0)||i==="right"&&(d+1>=t||o[f][d+1]!==0)||i==="left"&&(d-1<0||o[f][d-1]!==0))return!1}return!0}function P(o){return{x:Math.trunc(o.x),y:Math.trunc(o.y)}}const c={transparent:"transparent",red:"red",green:"green",blue:"blue",yellow:"yellow",orange:"orange",violet:"violet",coral:"coral",lightgreen:"lightgreen",cyan:"cyan",darkGrey:"#4f4f4f",lineColor:"#ffffff09",solidColor:"lightcoral"},p=[{id:"i",x:4,y:0,color:c.cyan,template:[[1,1,1,1]]},{id:"j",x:4,y:0,color:c.blue,template:[[1,1,1],[0,0,1]]},{id:"l",x:4,y:0,color:c.orange,template:[[1,1,1],[1,0,0]]},{id:"o",x:4,y:0,color:c.yellow,template:[[1,1],[1,1]]},{id:"s",x:4,y:0,color:c.lightgreen,template:[[0,1,1],[1,1,0]]},{id:"t",x:4,y:0,color:c.violet,template:[[0,1,0],[1,1,1]]},{id:"z",x:4,y:0,color:c.coral,template:[[1,1,0],[0,1,1]]}],y={single:100,double:200,triple:300,tetris:800,doubleTetris:1200},r={mainCanvasId:"game-canvas",pieceCanvasId:"piece-canvas",scoreElementId:"score",tetrisElementId:"tetris",highScoreElementId:"highscore",soundEnabled:!0,squareSize:30,backgroundColor:"#4f4f4f",lineColor:"#ffffff09",lineThickness:2,solidColor:"lightcoral",tickRate:4,frameRate:30,canvasHeight:600,canvasWidth:300,boardOffset:4};class R extends x{constructor(){super(r.tickRate,r.frameRate),this.gameCanvas=document.getElementById(r.mainCanvasId),this.pieceCanvas=document.getElementById(r.pieceCanvasId),this.scoreElement=document.getElementById(r.scoreElementId),this.tetrisElement=document.getElementById(r.tetrisElementId),this.highScoreElement=document.getElementById(r.highScoreElementId),this.gameRenderer=new C(this.gameCanvas,r.canvasWidth,r.canvasHeight,c.darkGrey),this.pieceRenderer=new C(this.pieceCanvas,0,0,c.transparent),this.squareCountX=this.gameRenderer.getCanvasInfo().width/r.squareSize,this.squareCountY=this.gameRenderer.getCanvasInfo().height/r.squareSize,this.board=w(this.squareCountX,this.squareCountY+r.boardOffset),a.highScore=window.localStorage.getItem(r.highScoreElementId)||0,this.updateScores()}start(){this.currentPiece=m(p),this.nextPiece=m(p),this.renderNextPiece(),super.start()}handleRotationMovement(){u(this.board,this.currentPiece,this.squareCountX,this.squareCountY,"left")&&u(this.board,this.currentPiece,this.squareCountX,this.squareCountY,"right")&&u(this.board,this.currentPiece,this.squareCountX,this.squareCountY,"down")&&(this.currentPiece.template=this.currentPiece.template[0].map((e,t)=>this.currentPiece.template.map(s=>s[t]).reverse()))}handleLeftMovement(){u(this.board,this.currentPiece,this.squareCountX,this.squareCountY,"left")&&this.currentPiece.x--}handleRightMovement(){u(this.board,this.currentPiece,this.squareCountX,this.squareCountY,"right")&&this.currentPiece.x++}checkGameOver(){return this.board[0].some(e=>e!==0)}clearCompleteRows(){let e=0;for(let t=0;t<this.board.length;t++)this.board[t].every(s=>s!==0)&&(e++,this.board.splice(t,1),this.board.unshift(Array(this.squareCountX).fill(0)));e>=4?(a.previousTetris=!0,a.playerScore+=a.previousTetris?y.doubleTetris:y.tetris,a.tetrisCount++):(a.previousTetris=!1,a.playerScore+=e*y.single),this.updateScores()}updateScores(){this.scoreElement.innerText=`Score: ${a.playerScore}`,this.tetrisElement.innerText=`Tetris: ${a.tetrisCount}`,this.highScoreElement.innerText=`Highscore: ${a.highScore}`}update(){if(!a.gameOver)if(u(this.board,this.currentPiece,this.squareCountX,this.squareCountY))this.currentPiece.y++;else{let e=P({x:this.currentPiece.x,y:this.currentPiece.y});for(let t=0;t<this.currentPiece.template.length;t++)for(let s=0;s<this.currentPiece.template[t].length;s++){if(this.currentPiece.template[t][s]===0)continue;let i=s+e.x,n=t+e.y;this.board[n][i]=1}this.currentPiece.y=0,this.currentPiece.x=Math.trunc(this.squareCountX/2),this.currentPiece=this.nextPiece,this.nextPiece=m(p),this.clearCompleteRows(),this.renderNextPiece(),this.checkGameOver()&&(a.gameOver=!0,a.playerScore>a.highScore&&(a.highScore=a.playerScore,window.localStorage.setItem("highscore",a.highScore)))}}renderBackground(){for(let e=0;e<this.squareCountX;e++)this.gameRenderer.drawRect(r.squareSize*e-r.lineThickness,0,r.lineThickness,this.gameRenderer.getCanvasInfo().height,c.lineColor);for(let e=0;e<this.squareCountY;e++)this.gameRenderer.drawRect(0,r.squareSize*e-r.lineThickness,this.gameRenderer.getCanvasInfo().width,r.lineThickness,c.lineColor)}renderBoard(){for(let e=0;e<this.board.length;e++){const t=this.board[e];for(let s=0;s<t.length;s++)this.board[e][s]!==0&&this.gameRenderer.drawRect(s*r.squareSize,e*r.squareSize,r.squareSize-r.lineThickness,r.squareSize-r.lineThickness,c.solidColor)}}renderCurrentPiece(){for(let e=0;e<this.currentPiece.template.length;e++)for(let t=0;t<this.currentPiece.template[e].length;t++)this.currentPiece.template[e][t]!==0&&this.gameRenderer.drawRect((this.currentPiece.x+t)*r.squareSize,(this.currentPiece.y+e)*r.squareSize,r.squareSize-r.lineThickness,r.squareSize-r.lineThickness,this.currentPiece.color)}renderNextPiece(){this.pieceRenderer.resize({width:this.nextPiece.template[0].length*r.squareSize,height:r.squareSize*2});for(let e=0;e<this.nextPiece.template.length;e++)for(let t=0;t<this.nextPiece.template[e].length;t++)this.nextPiece.template[e][t]!==0&&this.pieceRenderer.drawRect(t*r.squareSize,e*r.squareSize,r.squareSize-r.lineThickness,r.squareSize-r.lineThickness,this.nextPiece.color)}renderGameOver(){this.gameRenderer.setBackgroundColor(c.solidColor)}render(){if(this.gameRenderer.clear(),a.gameOver){this.renderGameOver();return}this.renderBackground(),this.renderBoard(),this.renderCurrentPiece()}}const v=document.getElementById("start-button"),h=new R;v.addEventListener("click",o=>{o.preventDefault(),o.stopPropagation(),v.style.display="none",h.start()});window.addEventListener("keydown",o=>{o.key==="ArrowLeft"&&(h==null||h.handleLeftMovement()),o.key==="ArrowRight"&&(h==null||h.handleRightMovement()),o.key==="ArrowUp"&&(h==null||h.handleRotationMovement())});
